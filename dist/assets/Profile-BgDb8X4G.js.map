{"version":3,"file":"Profile-BgDb8X4G.js","sources":["../../src/views/dashboard/Profile.vue"],"sourcesContent":["<script setup lang=\"ts\">\r\nimport { ref, onMounted } from 'vue'\r\nimport { Save, Upload, Lock, User } from 'lucide-vue-next'\r\nimport { useToast } from '@/composables/useToast'\r\nimport { useAuthStore } from '@/stores/auth'\r\nimport axios from '@/lib/axios'\r\nimport * as Sentry from '@sentry/vue'\r\nimport { getFullAvatarUrl } from '@/utils/url'\r\nimport analyticsImage from '@/assets/images/analytics/analytics-green.png'\r\n\r\nconst toast = useToast()\r\nconst authStore = useAuthStore()\r\n\r\ninterface Profile {\r\n  name: string\r\n  email: string\r\n  avatar: string\r\n}\r\n\r\ninterface PasswordForm {\r\n  currentPassword: string\r\n  newPassword: string\r\n  confirmPassword: string\r\n}\r\n\r\nconst profile = ref<Profile>({\r\n  name: '',\r\n  email: '',\r\n  avatar: authStore.avatar\r\n})\r\n\r\nconst showDefaultAvatar = ref(false)\r\n\r\nconst passwordForm = ref<PasswordForm>({\r\n  currentPassword: '',\r\n  newPassword: '',\r\n  confirmPassword: ''\r\n})\r\n\r\nconst avatarPreview = ref<string | null>(null)\r\nconst saving = ref(false)\r\nconst changingPassword = ref(false)\r\nconst avatarRef = ref<HTMLImageElement | null>(null)\r\n\r\n// Track failed avatar URLs to prevent infinite loops\r\nconst failedAvatarUrls = new Set<string>()\r\n\r\n// Handle avatar load errors\r\nconst handleAvatarError = () => {\r\n  if (!avatarRef.value) return\r\n  \r\n  const currentSrc = avatarRef.value.src\r\n  \r\n  // Prevent infinite loops by tracking failed URLs\r\n  if (!failedAvatarUrls.has(currentSrc)) {\r\n    failedAvatarUrls.add(currentSrc)\r\n    \r\n    // Log URL construction details\r\n    const urlDetails = {\r\n      attemptedSrc: currentSrc,\r\n      originalAvatar: profile.value.avatar,\r\n      authStoreAvatar: authStore.avatar,\r\n      constructedUrl: getFullAvatarUrl(profile.value.avatar || authStore.avatar),\r\n      apiUrl: import.meta.env.VITE_API_URL,\r\n      userId: authStore.username,\r\n      mediaPath: currentSrc.includes('media/avatars/') ? 'media path found' : 'no media path'\r\n    }\r\n\r\n    // Track error in Sentry with detailed URL info\r\n    Sentry.captureMessage('Avatar failed to load', {\r\n      level: 'warning',\r\n      extra: {\r\n        ...urlDetails,\r\n        fallbackApplied: true\r\n      }\r\n    })\r\n\r\n    console.error('Avatar load failed:', urlDetails)\r\n    \r\n    // Show error message only once\r\n    toast.error('Failed to load avatar image')\r\n    \r\n    // Show default avatar icon\r\n    showDefaultAvatar.value = true\r\n  }\r\n}\r\n\r\n// Load user profile\r\nconst loadProfile = async () => {\r\n  try {\r\n    const response = await axios.get('/users/profile/')\r\n    profile.value = response.data\r\n    // Reset default avatar flag when loading new profile\r\n    showDefaultAvatar.value = false\r\n  } catch (error) {\r\n    Sentry.captureException(error, {\r\n      extra: {\r\n        context: 'Profile load failed',\r\n        username: authStore.username\r\n      }\r\n    })\r\n    toast.error('Failed to load profile')\r\n  }\r\n}\r\n\r\n// Handle avatar upload\r\nconst handleAvatarUpload = async (event: Event) => {\r\n  const input = event.target as HTMLInputElement\r\n  if (input.files && input.files[0]) {\r\n    const file = input.files[0]\r\n    \r\n    // Preview\r\n    const reader = new FileReader()\r\n    reader.onload = (e) => {\r\n      avatarPreview.value = e.target?.result as string\r\n      // Reset default avatar flag when showing preview\r\n      showDefaultAvatar.value = false\r\n    }\r\n    reader.readAsDataURL(file)\r\n\r\n    // Upload\r\n    const formData = new FormData()\r\n    formData.append('avatar', file)\r\n    \r\n    try {\r\n      const response = await axios.post('/users/upload_avatar/', formData, {\r\n        headers: {\r\n          'Content-Type': 'multipart/form-data'\r\n        }\r\n      })\r\n      \r\n      toast.success('Avatar updated successfully')\r\n      // Update auth store with new avatar URL\r\n      authStore.updateAvatar(response.data.avatar_url)\r\n    } catch (error: any) {\r\n      // Track error in Sentry\r\n      Sentry.captureException(error, {\r\n        extra: {\r\n          context: 'Avatar upload failed',\r\n          username: authStore.username,\r\n          fileSize: file.size,\r\n          fileType: file.type\r\n        }\r\n      })\r\n      \r\n      toast.error('Failed to update avatar')\r\n      avatarPreview.value = null\r\n      showDefaultAvatar.value = true\r\n    }\r\n  }\r\n}\r\n\r\n// Handle profile save\r\nconst handleSaveProfile = async () => {\r\n  saving.value = true\r\n  try {\r\n    await axios.put('/users/update_profile/', {\r\n      name: profile.value.name,\r\n      email: profile.value.email\r\n    })\r\n    toast.success('Profile updated successfully')\r\n  } catch (error) {\r\n    Sentry.captureException(error, {\r\n      extra: {\r\n        context: 'Profile update failed',\r\n        username: authStore.username\r\n      }\r\n    })\r\n    toast.error('Failed to update profile')\r\n  } finally {\r\n    saving.value = false\r\n  }\r\n}\r\n\r\n// Handle password change\r\nconst handleChangePassword = async () => {\r\n  if (!passwordForm.value.currentPassword) {\r\n    toast.error('Please enter your current password')\r\n    return\r\n  }\r\n  if (passwordForm.value.newPassword !== passwordForm.value.confirmPassword) {\r\n    toast.error('New passwords don\\'t match')\r\n    return\r\n  }\r\n  if (passwordForm.value.newPassword.length < 8) {\r\n    toast.error('Password must be at least 8 characters long')\r\n    return\r\n  }\r\n\r\n  changingPassword.value = true\r\n  try {\r\n    await axios.post('/users/change_password/', {\r\n      current_password: passwordForm.value.currentPassword,\r\n      new_password: passwordForm.value.newPassword\r\n    })\r\n    toast.success('Password changed successfully')\r\n    passwordForm.value = {\r\n      currentPassword: '',\r\n      newPassword: '',\r\n      confirmPassword: ''\r\n    }\r\n  } catch (error) {\r\n    Sentry.captureException(error, {\r\n      extra: {\r\n        context: 'Password change failed',\r\n        username: authStore.username\r\n      }\r\n    })\r\n    toast.error('Failed to change password')\r\n  } finally {\r\n    changingPassword.value = false\r\n  }\r\n}\r\n\r\nonMounted(loadProfile)\r\n</script>\r\n\r\n<template>\r\n  <div class=\"flex-1 p-6\">\r\n    <div class=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      <!-- Welcome Section -->\r\n      <div class=\"mb-8 bg-white rounded-lg shadow-sm p-6\">\r\n        <div class=\"flex justify-between items-start\">\r\n          <div class=\"flex-1\">\r\n            <h1 class=\"text-xl md:text-2xl font-medium text-green-800 mb-2\">\r\n              Profile Settings\r\n            </h1>\r\n            <p class=\"text-gray-600 text-lg\">\r\n              Manage your account's essential security settings in one convenient place. Update your email address to ensure you never miss important notifications, and maintain your account's security by regularly updating your password. Your account's security is our priority.\r\n            </p>\r\n          </div>\r\n          <div class=\"w-48 h-48 flex-shrink-0 relative\">\r\n            <img\r\n              :src=\"analyticsImage\"\r\n              alt=\"Profile Settings illustration\"\r\n              class=\"w-full h-full object-contain\"\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- Avatar and Name Section -->\r\n      <div class=\"bg-white shadow-lg rounded-lg overflow-hidden mb-8\">\r\n        <div class=\"p-6\">\r\n          <div class=\"flex items-center space-x-6\">\r\n            <div class=\"relative w-24 h-24\">\r\n              <template v-if=\"!showDefaultAvatar && (avatarPreview || profile.avatar || authStore.avatar)\">\r\n                <img\r\n                  :src=\"avatarPreview || getFullAvatarUrl(profile.avatar) || getFullAvatarUrl(authStore.avatar)\"\r\n                  :alt=\"profile.name\"\r\n                  class=\"w-24 h-24 rounded-full object-cover border-4 border-green-200\"\r\n                  @error=\"handleAvatarError\"\r\n                  ref=\"avatarRef\"\r\n                />\r\n              </template>\r\n              <template v-else>\r\n                <div class=\"w-24 h-24 rounded-full bg-gray-100 border-4 border-green-200 flex items-center justify-center\">\r\n                  <User class=\"w-12 h-12 text-gray-400\" />\r\n                </div>\r\n              </template>\r\n              <label\r\n                for=\"avatar-upload\"\r\n                class=\"absolute bottom-0 right-0 bg-white rounded-full p-2 shadow-lg cursor-pointer hover:bg-gray-50\"\r\n              >\r\n                <Upload class=\"w-4 h-4 text-gray-600\" />\r\n                <input\r\n                  id=\"avatar-upload\"\r\n                  type=\"file\"\r\n                  accept=\"image/*\"\r\n                  class=\"hidden\"\r\n                  @change=\"handleAvatarUpload\"\r\n                />\r\n              </label>\r\n            </div>\r\n            <div>\r\n              <h3 class=\"text-xl font-semibold text-gray-900 mb-2\">{{ profile.name }}</h3>\r\n              <p class=\"text-base text-gray-500\">Click the icon to change your avatar</p>\r\n            </div>\r\n          </div>\r\n          <div class=\"mt-6 space-y-4\">\r\n            <div>\r\n              <label for=\"name\" class=\"block text-sm font-medium text-gray-700 mb-1\">Name</label>\r\n              <input\r\n                id=\"name\"\r\n                v-model=\"profile.name\"\r\n                type=\"text\"\r\n                class=\"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label for=\"email\" class=\"block text-sm font-medium text-gray-700 mb-1\">Email</label>\r\n              <input\r\n                id=\"email\"\r\n                v-model=\"profile.email\"\r\n                type=\"email\"\r\n                class=\"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n              />\r\n            </div>\r\n            <button\r\n              @click=\"handleSaveProfile\"\r\n              class=\"inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500\"\r\n              :disabled=\"saving\"\r\n            >\r\n              <Save class=\"w-4 h-4 mr-2\" />\r\n              {{ saving ? 'Saving...' : 'Save Profile' }}\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- Password Change Card -->\r\n      <div class=\"bg-white shadow-lg rounded-lg overflow-hidden\">\r\n        <div class=\"p-6\">\r\n          <div class=\"flex items-center gap-3 mb-6\">\r\n            <div class=\"flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-50\">\r\n              <Lock class=\"w-5 h-5 text-emerald-600\" />\r\n            </div>\r\n            <div>\r\n              <h2 class=\"text-lg font-medium text-gray-700\">Change Password</h2>\r\n              <p class=\"text-base text-gray-500\">Update your password to keep your account secure.</p>\r\n            </div>\r\n          </div>\r\n          \r\n          <div class=\"space-y-4\">\r\n            <div>\r\n              <label for=\"current-password\" class=\"block text-sm font-medium text-gray-700 mb-1\">Current Password</label>\r\n              <input\r\n                id=\"current-password\"\r\n                v-model=\"passwordForm.currentPassword\"\r\n                type=\"password\"\r\n                class=\"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label for=\"new-password\" class=\"block text-sm font-medium text-gray-700 mb-1\">New Password</label>\r\n              <input\r\n                id=\"new-password\"\r\n                v-model=\"passwordForm.newPassword\"\r\n                type=\"password\"\r\n                class=\"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n              />\r\n              <p class=\"text-sm text-gray-500 mt-1\">Password must be at least 8 characters long</p>\r\n            </div>\r\n            <div>\r\n              <label for=\"confirm-password\" class=\"block text-sm font-medium text-gray-700 mb-1\">Confirm New Password</label>\r\n              <input\r\n                id=\"confirm-password\"\r\n                v-model=\"passwordForm.confirmPassword\"\r\n                type=\"password\"\r\n                class=\"w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500\"\r\n              />\r\n            </div>\r\n          </div>\r\n          <button\r\n            @click=\"handleChangePassword\"\r\n            class=\"mt-6 inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500\"\r\n            :disabled=\"changingPassword\"\r\n          >\r\n            <Lock class=\"w-4 h-4 mr-2\" />\r\n            {{ changingPassword ? 'Changing...' : 'Change Password' }}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n"],"names":["toast","useToast","authStore","useAuthStore","profile","ref","showDefaultAvatar","passwordForm","avatarPreview","saving","changingPassword","avatarRef","failedAvatarUrls","handleAvatarError","currentSrc","urlDetails","getFullAvatarUrl","Sentry.captureMessage","loadProfile","response","axios","error","Sentry.captureException","handleAvatarUpload","event","input","file","reader","e","_a","formData","handleSaveProfile","handleChangePassword","onMounted"],"mappings":"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"}