var M=Object.defineProperty;var O=(t,e,a)=>e in t?M(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var m=(t,e,a)=>(O(t,typeof e!="symbol"?e+"":e,a),a);import{aY as v,k as F,b6 as N,I as h,cA as j,s as B,cB as H,d as w,c3 as g,bo as Y,cj as J}from"./main-Dr4KW1PH.js";const p={async getUserFeedback(){try{return(await v.get("/feedback/user/")).data}catch(t){throw console.error("Failed to fetch user feedback:",t),new Error("Failed to fetch your feedback. Please try again later.")}},async createFeedback(t){var e;console.log("FeedbackService: Starting createFeedback"),console.log("FeedbackService: Request data:",{message:((e=t.message)==null?void 0:e.substring(0,50))+"...",hasAttachment:!!t.attachment});try{const a=new FormData;a.append("message",t.message),t.attachment&&(a.append("attachment",t.attachment),console.log("FeedbackService: Attached file:",{name:t.attachment.name,type:t.attachment.type,size:t.attachment.size})),console.log("FeedbackService: Sending POST request to /feedback/user/");const c=await v.post("/feedback/user/",a);return console.log("FeedbackService: Request successful, response:",{status:c.status,data:{id:c.data.id,status:c.data.status,created_at:c.data.created_at}}),c.data}catch(a){if(console.error("FeedbackService: Request failed:",a),a&&typeof a=="object"&&"response"in a){const c=a;c.response&&console.error("FeedbackService: Error response:",{status:c.response.status,data:c.response.data})}throw a instanceof Error?a:new Error("Failed to submit your feedback. Please try again later.")}},async getAllFeedback(){try{return(await v.get("/feedback/admin/")).data}catch(t){throw console.error("Failed to fetch all feedback:",t),new Error("Failed to fetch feedback list. Please try again later.")}},async getFeedbackDetails(t){try{return(await v.get(`/feedback/${t}/`)).data}catch(e){throw console.error(`Failed to fetch feedback ${t}:`,e),new Error("Failed to fetch feedback details. Please try again later.")}},async updateFeedbackStatus(t,e){try{return(await v.patch(`/feedback/${t}/`,{status:e})).data}catch(a){throw console.error(`Failed to update feedback ${t} status:`,a),new Error("Failed to update feedback status. Please try again later.")}},async createReply(t,e){try{return(await v.post(`/feedback/${t}/reply/`,{message:e})).data}catch(a){throw console.error(`Failed to create reply to feedback ${t}:`,a),new Error("Failed to send your reply. Please try again later.")}},async clearAllFeedback(){try{await v.post("/feedback/admin/clear/")}catch(t){throw console.error("Failed to clear feedback:",t),new Error("Failed to clear feedback data. Please try again later.")}},async deleteFeedback(t){try{console.log(`FeedbackService: Attempting to delete feedback ${t}`);const e=await v.delete(`/feedback/${t}/`);console.log("FeedbackService: Delete response status:",e.status)}catch(e){if(console.error(`FeedbackService: Failed to delete feedback ${t}:`,e),e&&typeof e=="object"&&"response"in e){const a=e;if(a.response&&(console.error("FeedbackService: Error response:",{status:a.response.status,data:a.response.data}),a.response.status===403))throw new Error("You do not have permission to delete feedback.")}throw new Error("Failed to delete feedback. Please try again later.")}}};class G{constructor(){m(this,"socket",null);m(this,"reconnectAttempts",0);m(this,"maxReconnectAttempts",10);m(this,"reconnectTimeout",3e3);m(this,"connectionTimeout",15e3);m(this,"connectionTimer",null);m(this,"isConnected",F(!1))}async connect(){return new Promise((e,a)=>{var i;if(((i=this.socket)==null?void 0:i.readyState)===WebSocket.OPEN){console.debug("WebSocket: Already connected"),e();return}console.debug("WebSocket: Starting connection...");const c=localStorage.getItem("access_token");if(!c){const u=new Error("No authentication token found. Please log in again.");console.error("WebSocket:",u.message),a(u);return}try{const u=window.location.protocol==="https:"?"wss:":"ws:",d=window.location.host;this.connectionTimer=setTimeout(()=>{this.socket&&this.socket.readyState!==WebSocket.OPEN&&(console.error("WebSocket: Connection timeout"),this.socket.close(),a(new Error("Connection timeout")))},this.connectionTimeout),this.socket=new WebSocket(`${u}//${d}/ws/feedback/?token=${c}`),this.socket.onopen=()=>{this.connectionTimer&&(clearTimeout(this.connectionTimer),this.connectionTimer=null),console.debug("WebSocket: Connected successfully"),this.isConnected.value=!0,this.reconnectAttempts=0,e()},this.socket.onclose=b=>{switch(this.connectionTimer&&(clearTimeout(this.connectionTimer),this.connectionTimer=null),console.debug(`WebSocket: Disconnected with code ${b.code}`),this.isConnected.value=!1,b.code){case 1e3:console.debug("WebSocket: Closed normally");break;case 1001:this.reconnect();break;case 1006:console.warn("WebSocket: Abnormal closure (possible Cloudflare timeout)"),this.reconnect();break;case 4001:console.error("WebSocket: Unauthorized");break;default:b.code>=4e3?console.error(`WebSocket: Application error ${b.code}`):(console.warn(`WebSocket: Connection lost (code ${b.code})`),this.reconnect())}this.isConnected.value||a(new Error(`Connection closed with code ${b.code}`))},this.socket.onerror=b=>{console.error("WebSocket: Error occurred:",b)},this.socket.onmessage=b=>{console.debug("WebSocket: Received message:",b.data)}}catch(u){this.connectionTimer&&(clearTimeout(this.connectionTimer),this.connectionTimer=null),console.error("WebSocket: Failed to create connection:",u),a(u)}})}reconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnection attempts reached");return}this.reconnectAttempts++;const e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${e/1e3}s...`),setTimeout(()=>{this.connect()},e)}subscribe(e){if(!this.socket)throw new Error("WebSocket not initialized");this.socket.onmessage=a=>{try{const c=JSON.parse(a.data);e(c)}catch(c){console.error("Failed to parse WebSocket message:",c)}}}disconnect(){this.socket&&(this.socket.close(),this.socket=null)}}const V=new G,K=N("feedback",()=>{const t=F([]),e=F(!1),a=F(!1),c=F(null),i=F("all"),u=F(""),d=F(null),b=h(()=>{let o=t.value;if(i.value!=="all"&&(o=o.filter(r=>r.status===i.value)),u.value){const r=u.value.toLowerCase();o=o.filter(s=>s.message.toLowerCase().includes(r)||s.user.toLowerCase().includes(r)||s.replies.some(l=>l.message.toLowerCase().includes(r)||l.user.toLowerCase().includes(r)))}return o}),x=h(()=>t.value.length),D=h(()=>t.value.filter(o=>o.status==="pending").length),$=h(()=>t.value.filter(o=>o.status==="resolved").length);async function T(){if(!e.value){e.value=!0,c.value=null;try{t.value=await p.getUserFeedback()}catch(o){c.value=o instanceof Error?o.message:"Failed to fetch feedback",console.error("Error fetching feedback:",o)}finally{e.value=!1}}}async function A(){if(!e.value){e.value=!0,c.value=null;try{t.value=await p.getAllFeedback()}catch(o){c.value=o instanceof Error?o.message:"Failed to fetch feedback",console.error("Error fetching feedback:",o)}finally{e.value=!1}}}async function R(o,r){if(console.log("FeedbackStore: Starting createFeedback"),a.value)throw console.log("FeedbackStore: Submission already in progress"),c.value="A submission is already in progress",new Error("A submission is already in progress");a.value=!0,c.value=null;try{return await p.createFeedback({message:o,attachment:r})}catch(s){throw c.value=s instanceof Error?s.message:"Failed to submit feedback",s}finally{a.value=!1}}async function P(o,r){var s;if(!e.value){e.value=!0,c.value=null;try{const l=await p.updateFeedbackStatus(o,r),f=t.value.findIndex(k=>k.id===o);return f!==-1&&(t.value[f]=l),((s=d.value)==null?void 0:s.id)===o&&(d.value=l),l}catch(l){throw c.value=l instanceof Error?l.message:"Failed to update status",console.error("Error updating status:",l),l}finally{e.value=!1}}}async function I(o,r){var s;if(!a.value){a.value=!0,c.value=null;try{const l=await p.createReply(o,r),f=t.value.findIndex(k=>k.id===o);if(f!==-1){const k=await p.getFeedbackDetails(o);t.value[f]=k,((s=d.value)==null?void 0:s.id)===o&&(d.value=k)}return l}catch(l){throw c.value=l instanceof Error?l.message:"Failed to submit reply",console.error("Error submitting reply:",l),l}finally{a.value=!1}}}function _(o){i.value=o}function z(o){u.value=o}function U(o){d.value=o}async function C(o){var r;if(!e.value){e.value=!0,c.value=null;try{await p.deleteFeedback(o),t.value=t.value.filter(s=>s.id!==o),((r=d.value)==null?void 0:r.id)===o&&(d.value=null)}catch(s){throw c.value=s instanceof Error?s.message:"Failed to delete feedback",console.error("Error deleting feedback:",s),s}finally{e.value=!1}}}async function q(){if(!e.value){e.value=!0,c.value=null;try{await p.clearAllFeedback(),t.value=[],d.value=null}catch(o){throw c.value=o instanceof Error?o.message:"Failed to clear feedback",console.error("Error clearing feedback:",o),o}finally{e.value=!1}}}async function L(o=!1){try{o?await A():await T();try{await V.connect(),console.debug("FeedbackStore: WebSocket connected, setting up subscription"),V.subscribe(r=>{var s,l;if(console.debug("FeedbackStore: Received WebSocket message:",r.type),r.type==="feedback_deleted")console.debug("FeedbackStore: Processing feedback deletion:",r.data.id),t.value=t.value.filter(f=>f.id!==r.data.id),((s=d.value)==null?void 0:s.id)===r.data.id&&(d.value=null);else if(r.type==="feedback_update"){const f=t.value.findIndex(k=>k.id===r.data.id);f!==-1?(console.debug("FeedbackStore: Updating existing feedback:",r.data.id),t.value[f]=r.data,((l=d.value)==null?void 0:l.id)===r.data.id&&(d.value=r.data)):(console.debug("FeedbackStore: Adding new feedback:",r.data.id),t.value.unshift(r.data))}else if(r.type==="feedback_reply"){const f=r.data.feedback_id;console.debug("FeedbackStore: Processing new reply for feedback:",f);const k=t.value.findIndex(S=>S.id===f);k!==-1&&p.getFeedbackDetails(f).then(S=>{var W;console.debug("FeedbackStore: Updating feedback with new reply:",f),t.value[k]=S,((W=d.value)==null?void 0:W.id)===f&&(d.value=S)})}})}catch(r){if(console.error("FeedbackStore: Failed to setup WebSocket:",r),r instanceof Error&&r.message.includes("authentication")){window.location.href="/login";return}c.value=r instanceof Error?r.message:"Failed to connect to WebSocket"}}catch(r){if(console.error("FeedbackStore: Failed to initialize feedback:",r),r instanceof Error&&r.message.includes("authentication")){window.location.href="/login";return}throw c.value=r instanceof Error?r.message:"Failed to load feedback",r}}return{items:t,isLoading:e,isSubmitting:a,error:c,filterStatus:i,searchTerm:u,selectedItem:d,filteredItems:b,totalFeedback:x,pendingFeedback:D,resolvedFeedback:$,fetchUserFeedback:T,fetchAllFeedback:A,createFeedback:R,updateStatus:P,createReply:I,setFilterStatus:_,setSearchTerm:z,setSelectedItem:U,deleteFeedback:C,clearAllFeedback:q,initializeFeedback:L,isWebSocketConnected:V.isConnected}});function ee(){const t=K(),e=j({message:""}),{items:a,isLoading:c,isSubmitting:i,error:u,filterStatus:d,searchTerm:b,selectedItem:x,filteredItems:D}=B(t),$=h(()=>!!u.value),T=h(()=>!c.value&&a.value.length===0),A=h(()=>a.value.length>0),R=h(()=>!!x.value),P=h(()=>a.value.length),I=h(()=>a.value.filter(n=>n.status==="pending").length),_=h(()=>a.value.filter(n=>n.status==="resolved").length),z=h(()=>a.value.filter(n=>n.status==="reviewed").length),U=n=>{Object.assign(e,n)},C=()=>{e.message="",delete e.attachment},q=async()=>{if(console.log("useFeedback: Starting feedback submission"),console.log("useFeedback: Current form state:",{message:e.message,hasAttachment:!!e.attachment}),console.log("useFeedback: Current store state:",{isSubmitting:i.value,error:u.value}),!e.message)throw console.log("useFeedback: Missing required message"),new Error("Message is required");try{i.value=!1,console.log("useFeedback: Calling store.createFeedback");const n=await t.createFeedback(e.message,e.attachment);return console.log("useFeedback: Submission successful, result:",n),console.log("useFeedback: Resetting form"),C(),n}catch(n){throw console.error("useFeedback: Submission failed:",n),console.log("useFeedback: Store state after error:",{isSubmitting:i.value,error:u.value}),u.value=n instanceof Error?n.message:"Failed to submit feedback",n}finally{console.log("useFeedback: Resetting isSubmitting in finally block"),i.value=!1}},L=async()=>{try{await t.fetchUserFeedback()}catch(n){throw console.error("Failed to fetch user feedback:",n),n}},o=async()=>{try{await t.fetchAllFeedback()}catch(n){throw console.error("Failed to fetch all feedback:",n),n}},r=async(n,E)=>{try{return await t.updateStatus(n,E)}catch(y){throw console.error("Failed to update status:",y),y}},s=async(n,E)=>{try{return await t.createReply(n,E)}catch(y){throw console.error("Failed to create reply:",y),y}},l=n=>{t.setFilterStatus(n)},f=n=>{t.setSearchTerm(n)},k=n=>{t.setSelectedItem(n)},S=async()=>{try{await t.clearAllFeedback()}catch(n){throw console.error("Failed to clear feedback:",n),n}},W=async(n=!1)=>{try{await t.initializeFeedback(n)}catch(E){throw console.error("Failed to initialize feedback:",E),E}};return{items:a,isLoading:c,isSubmitting:i,error:u,filterStatus:d,searchTerm:b,selectedItem:x,filteredItems:D,formData:H(e),hasError:$,isEmpty:T,hasItems:A,hasSelectedItem:R,totalFeedback:P,pendingFeedback:I,resolvedFeedback:_,inProgressFeedback:z,updateFormData:U,resetForm:C,submitFeedback:q,fetchUserFeedback:L,fetchAllFeedback:o,clearAllFeedback:S,initializeFeedback:W,updateStatus:r,createReply:s,setFilterStatus:l,setSearchTerm:f,setSelectedItem:k}}const Q=Y("flex min-h-[80px] w-full rounded-md border border-gray-200 bg-white px-3 py-2 text-sm placeholder:text-gray-500 focus:border-green-500 focus:outline-none focus:ring-1 focus:ring-green-500 disabled:cursor-not-allowed disabled:opacity-50",{variants:{variant:{default:"",error:"border-red-500"}},defaultVariants:{variant:"default"}}),te=w({name:"Textarea",props:{variant:{type:String,default:"default"},modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(t,{attrs:e,emit:a}){const c=h(()=>Q({variant:t.variant}));return()=>g("textarea",{class:c.value,value:t.modelValue,onInput:i=>{a("update:modelValue",i.target.value)},...e})}}),ae=w({name:"Dialog",props:{open:{type:Boolean,required:!0}},emits:["update:open"],setup(t,{emit:e,slots:a}){const c=()=>{e("update:open",!1)};return()=>t.open?g("div",{class:"fixed inset-0 z-50 bg-black bg-opacity-50",onClick:c},g("div",{class:"fixed inset-0 flex items-center justify-center p-4",onClick:i=>i.stopPropagation()},g(J,{enterActiveClass:"duration-200 ease-out",enterFromClass:"opacity-0 scale-95",enterToClass:"opacity-100 scale-100",leaveActiveClass:"duration-200 ease-in",leaveFromClass:"opacity-100 scale-100",leaveToClass:"opacity-0 scale-95"},()=>{var i;return g("div",{class:"w-full max-w-lg transform overflow-hidden rounded-lg bg-white p-6 shadow-xl"},(i=a.default)==null?void 0:i.call(a))}))):null}}),oe=w({name:"DialogContent",setup(t,{slots:e,attrs:a}){return()=>{var c;return g("div",{class:"relative w-full bg-white",...a},(c=e.default)==null?void 0:c.call(e))}}}),re=w({name:"DialogHeader",setup(t,{slots:e}){return()=>{var a;return g("div",{class:"flex flex-col space-y-1.5 text-center sm:text-left"},(a=e.default)==null?void 0:a.call(e))}}}),ce=w({name:"DialogTitle",setup(t,{slots:e}){return()=>{var a;return g("h2",{class:"text-lg font-semibold leading-none tracking-tight"},(a=e.default)==null?void 0:a.call(e))}}}),ne=w({name:"DialogDescription",setup(t,{slots:e}){return()=>{var a;return g("p",{class:"text-sm text-muted-foreground"},(a=e.default)==null?void 0:a.call(e))}}}),se=w({name:"DialogFooter",setup(t,{slots:e}){return()=>{var a;return g("div",{class:"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2"},(a=e.default)==null?void 0:a.call(e))}}});export{re as D,te as T,ce as a,ne as b,oe as c,ae as d,K as e,se as f,ee as u,V as w};
//# sourceMappingURL=index-CcYM-n4X.js.map
